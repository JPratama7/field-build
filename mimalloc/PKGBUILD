_pkgname=mimalloc
pkgname=${_pkgname}-git
pkgver=r31.8a81a6c
pkgrel=1
pkgdesc='General-purpose allocator with excellent performance characteristics'
arch=('x86_64')
license=('MIT')
url='https://github.com/microsoft/mimalloc'
depends=('glibc')
makedepends=('cmake')
provides=('libmimalloc.so')
_branch=master
source=("${_pkgname}::git+https://github.com/microsoft/${_pkgname}.git#branch=master")
sha256sums=('SKIP')

pkgver() {
  cd "$_pkgname"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

build() {
  cd "$_pkgname"
  export CFLAGS="${CFLAGS} -flto=thin"
  export CXXFLAGS="${CXXFLAGS} -std=c++17 -flto=thin"
  export LDFLAGS="${LDFLAGS} -fuse-ld=lld"
  cmake \
    -B build \
    -S "$_pkgname" \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DMI_BUILD_STATIC=OFF \
    -DMI_BUILD_OBJECT=OFF \
    -DMI_INSTALL_TOPLEVEL=ON

  cmake --build build
}

check() {
  cd build

  ctest --output-on-failure
}

package() {
  DESTDIR="$pkgdir" cmake --install build

  install -vDm644 -t "$pkgdir/usr/share/licenses/$pkgname" "$pkgname-$pkgver/LICENSE"
}